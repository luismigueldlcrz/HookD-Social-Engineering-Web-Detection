<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account | Astra</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile-style.css') }}">
</head>
<body class="astra-bg">

    <nav class="navbar navbar-expand-lg navbar-dark pt-4">
        <div class="container justify-content-center">
            <ul class="navbar-nav gap-4">
                <li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard') }}">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard') }}">Scanner</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('history') }}">History</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('about') }}">About</a></li>
            </ul>
        </div>
    </nav>

    <main class="container d-flex flex-column align-items-center">

        {% set full_name = profile.display_name if profile is defined else (user.name if user.name else '') %}
        {% set db_fname = profile.first_name if profile is defined else (user.first_name if user.first_name else '') %}
        {% set db_lname = profile.last_name if profile is defined else (user.last_name if user.last_name else '') %}
        {% set db_email = profile.email if profile is defined else (user.email if user.email else '') %}

        {% set name_parts = full_name.split() %}
        {% set count = name_parts|length %}
        
        {% set fallback_fname = '' %}
        {% set fallback_lname = '' %}

        {% if count == 4 %}
            {% set fallback_fname = name_parts[0] ~ ' ' ~ name_parts[1] %}
            {% set fallback_lname = name_parts[2] ~ ' ' ~ name_parts[3] %}
        {% elif count > 0 %}
            {% set fallback_fname = name_parts[0] %}
            {% set fallback_lname = name_parts[1:] | join(' ') %}
        {% endif %}

        {% set fname = db_fname if db_fname else fallback_fname %}
        {% set lname = db_lname if db_lname else fallback_lname %}
        
        {% set initial = fname[0] if fname else 'U' %}

        <div class="profile-card position-relative">
            <div class="avatar-container">
                <div class="profile-initial-circle">
                    {{ initial | upper }}
                </div>
            </div>

            <div class="text-center pt-5 mt-4">
                <h1 class="profile-heading">
                    My Profile 
                    <i data-lucide="pencil" class="edit-icon" onclick="toggleEditMode()"></i>
                </h1>
            </div>

            <form class="account-form mt-4" id="profile-form" method="POST" action="/update_profile">
                <div class="form-subheader mb-3">Account Information</div>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="input-label">First Name</label>
                        <input type="text" id="fname" name="first_name" class="form-control account-input" 
                               value="{{ fname }}" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="input-label">Last Name</label>
                        <input type="text" id="lname" name="last_name" class="form-control account-input" 
                               value="{{ lname }}" readonly>
                    </div>
                </div>

                <div class="mt-4">
                    <label class="input-label">Email Address</label>
                    <input type="email" class="form-control account-input" value="{{ db_email }}" readonly>
                </div>

                <div class="mt-4">
                    <label class="input-label">Password</label>
                    <input type="password" class="form-control account-input" placeholder="••••••••" readonly>
                </div>

                <div class="mt-5 d-flex flex-column gap-3">
                    <button type="submit" id="save-btn" class="btn-save d-none">Save Changes</button>
                    
                    <a href="{{ url_for('logout') }}" class="btn-logout text-center">Logout</a>
                </div>
            </form>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        lucide.createIcons();

        function toggleEditMode() {
            // 1. Get Elements
            const fname = document.getElementById('fname');
            const lname = document.getElementById('lname');
            const saveBtn = document.getElementById('save-btn');
            const icon = document.querySelector('.edit-icon');

            // 2. Check current state
            const isEditing = !fname.hasAttribute('readonly');

            if (isEditing) {
                // --- DISCARD CHANGES (Cancel) ---
                // Reset values to their defaults (what they were on page load)
                fname.value = fname.defaultValue;
                lname.value = lname.defaultValue;

                // Lock fields
                fname.setAttribute('readonly', 'true');
                lname.setAttribute('readonly', 'true');

                // Hide Save Button
                saveBtn.classList.add('d-none');

                // Reset Icon Color
                icon.style.color = "white"; 
                
            } else {
                // --- START EDITING ---
                fname.removeAttribute('readonly');
                lname.removeAttribute('readonly');

                // Show Save Button
                saveBtn.classList.remove('d-none');

                // Focus & Highlight Icon
                fname.focus();
                icon.style.color = "#c1ff72"; 
            }
        }
    </script>
</body>
</html>